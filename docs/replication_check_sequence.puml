@startuml Cluster State Sync Sequence

participant "ClusterManager" as ClusterMgr
participant "CRDT Consensus" as CRDT
participant "LocalPinTracker" as PinTracker
participant "IPFS Daemon" as IPFS
participant "Other Peers" as Peers

== Pinning (Ingest) ==

ClusterMgr -> CRDT: LogPin(ManifestCID)
CRDT -> CRDT: Update local Merkle-DAG
CRDT -> Peers: PubSub Broadcast (Heads)
Peers -> CRDT: Sync State

== Replication (PinTracker Loop) ==

PinTracker -> CRDT: State() (Poll/Watch)
CRDT -> PinTracker: Global Pin List

loop For each Pin in State
    PinTracker -> IPFS: IsPinned(CID)?
    alt Not Pinned Locally
        PinTracker -> IPFS: PinRecursive(CID)
        Note over PinTracker: Content replicated locally
    end
end

== Unpinning (Removal) ==

ClusterMgr -> CRDT: LogUnpin(ManifestCID)
CRDT -> Peers: Sync State
PinTracker -> CRDT: State()
PinTracker -> IPFS: UnpinRecursive(CID)

@enduml
