@startuml Replication Check Sequence

participant "Replication Checker" as ReplChecker
participant "Storage" as Storage
participant "ShardManager" as ShardMgr
participant "Backoff Manager" as Backoff
participant "DHT" as DHT
participant "PubSub" as PubSub
participant "Other Nodes" as Nodes

ReplChecker -> ReplChecker: runReplicationChecker()\n(periodic ticker)

loop For each known file
    ReplChecker -> Backoff: shouldSkipDueToBackoff(hash)
    alt In backoff period
        ReplChecker -> ReplChecker: Skip this file
    else Not in backoff
    ReplChecker -> Storage: isPinned(hash)  ' hash is ManifestCID string in tracking
        ReplChecker -> ShardMgr: AmIResponsibleFor(PayloadCID)\n(extracted from manifest for stable routing)
        ReplChecker -> IPFS: Verify manifest+payload pinned\n(and decode manifest)
        alt Payload size mismatch (liar detection)
            ReplChecker -> IPFS: UnpinRecursive(ManifestCID)
            ReplChecker -> Storage: unpinFile(ManifestCID)
            ReplChecker -> Storage: removeKnownFile(ManifestCID)
        end
        
        alt Not responsible AND not pinned
            ReplChecker -> Storage: removeKnownFile(hash)
        else Responsible OR pinned
            Note over ReplChecker: Check replicationCache first\n(use cached count if fresh)
            alt Cache miss or expired
                ReplChecker -> DHT: FindProvidersAsync(ManifestCID)\n(sample up to DHTMaxSampleSize)
                DHT -> DHT: Query network
                DHT -> ReplChecker: Provider count
                ReplChecker -> ReplChecker: Store count in replicationCache\n(with TTL)
            else Cache hit
                ReplChecker -> ReplChecker: Use cached provider count
            end
            
            ReplChecker -> Storage: Update fileReplicationLevels
            
            alt count < MinReplication
                ReplChecker -> ReplChecker: Check pendingVerifications
                alt No pending verification
                    Note over ReplChecker: Hysteresis: Verify before Act
                    ReplChecker -> ReplChecker: Schedule verification\n(random delay ~30s)
                    ReplChecker -> ReplChecker: Store firstCount, verifyTime
                    ReplChecker -> ReplChecker: Wait for verification delay
                else Verification time reached
                    ReplChecker -> DHT: FindProvidersAsync(cid)\n(SECOND QUERY)
                    DHT -> ReplChecker: Provider count (verification)
                    alt Verification confirms under-replication
                        alt Responsible AND not pinned
                            ReplChecker -> IPFS: PinRecursive(ManifestCID)
                            ReplChecker -> DHT: provideFile(ManifestCID)
                        end
                        ReplChecker -> PubSub: PublishToShard(ReplicationRequest CBOR)\n(shard topic only)
                        PubSub -> Nodes: Broadcast ReplicationRequest\n(only to same shard)
                        Nodes -> Nodes: Check if responsible\n(AmIResponsibleFor(PayloadCID))
                        alt Node is responsible
                            Nodes -> IPFS: Fetch and pin if not pinned
                            Nodes -> DHT: provideFile(manifest_cid)\n(only responsible nodes announce)
                        else Node not responsible
                            Nodes -> Nodes: Ignore (not in responsible shard)
                        end
                        Note over ReplChecker: Both queries confirmed\nunder-replication\nOnly responsible nodes respond
                    else Verification shows adequate replication
                        Note over ReplChecker: First query was false alarm\nCanceling NEED
                        ReplChecker -> ReplChecker: Remove pending verification
                    end
                else Verification still pending
                    Note over ReplChecker: Waiting for verification delay
                end
            else count > MaxReplication
                alt Responsible AND pinned
                    ReplChecker -> Storage: unpinFile(hash)
                    alt count > MaxReplication + 3
                        ReplChecker -> Storage: removeKnownFile(hash)
                    end
                end
            else count >= MinReplication AND count <= MaxReplication
                alt Not responsible BUT pinned (custodial)
                    ReplChecker -> Storage: unpinFile(hash)
                end
            end
            
            alt DHT query failed
                ReplChecker -> Backoff: recordFailedOperation(hash)
            else DHT query succeeded
                ReplChecker -> Backoff: clearBackoff(hash)
            end
        end
    end
end

@enduml
