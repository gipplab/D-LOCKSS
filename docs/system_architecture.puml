@startuml D-LOCKSS System Architecture

!define RECTANGLE class

package "D-LOCKSS Node" {
    [Main] as main
    [ShardManager] as shardMgr
    [File Operations] as fileOps
    [Replication Checker] as replChecker
    [Storage Manager] as storage
    [Metrics Reporter] as metrics
    [Rate Limiter] as rateLimit
    [Backoff Manager] as backoff
    [Discovery Service] as discovery
}

package "libp2p Stack" {
    [libp2p Host] as host
    [Kademlia DHT] as dht
    [GossipSub PubSub] as pubsub
    [mDNS Discovery] as mdns
}

package "File System" {
    [./data Directory] as dataDir
    [File Watcher] as watcher
}

package "External" {
    [Other D-LOCKSS Nodes] as peers
    [IPFS Network] as ipfsNet
}

main --> shardMgr : manages
main --> fileOps : orchestrates
main --> replChecker : starts
main --> storage : uses
main --> metrics : collects
main --> rateLimit : uses
main --> backoff : uses
main --> discovery : initializes

shardMgr --> pubsub : subscribes/publishes
shardMgr --> host : uses

fileOps --> storage : pins/unpins
fileOps --> shardMgr : checks responsibility
fileOps --> dht : provides files
fileOps --> watcher : triggered by

replChecker --> dht : queries providers
replChecker --> shardMgr : publishes NEED
replChecker --> storage : manages pins
replChecker --> backoff : checks backoff

storage --> dht : provides files

metrics --> storage : reads state
metrics --> replChecker : tracks stats
metrics --> shardMgr : reads shard info

rateLimit --> pubsub : filters messages

backoff --> replChecker : controls retries

discovery --> mdns : uses
discovery --> host : connects peers

host --> dht : provides routing
host --> pubsub : provides messaging
host --> peers : connects

dht --> ipfsNet : queries providers
pubsub --> peers : broadcasts messages
mdns --> peers : discovers locally

watcher --> dataDir : monitors

@enduml
