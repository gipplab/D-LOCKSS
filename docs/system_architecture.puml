@startuml D-LOCKSS System Architecture

!define RECTANGLE class

package "D-LOCKSS Node" {
    [Main] as main
    [ShardManager] as shardMgr
    [ClusterManager] as clusterMgr
    [FileProcessor] as fileOps
    [StorageManager] as storage
    [Storage Monitor] as storageMonitor
    [Metrics Reporter] as metrics
    [Rate Limiter] as rateLimit
    [Discovery Service] as discovery
    [IPFS Client] as ipfsClient
    [Signing & Trust] as signingTrust

    package "Embedded Cluster" {
        [CRDT Consensus] as crdt
        [PinTracker] as pinTracker
    }
}

package "libp2p Stack" {
    [libp2p Host] as host
    [Kademlia DHT] as dht
    [GossipSub PubSub] as pubsub
    [mDNS Discovery] as mdns
}

package "File System" {
    [./data Directory] as dataDir
    [File Watcher] as watcher
    [Cluster Store] as clusterStore
}

package "External" {
    [Other D-LOCKSS Nodes] as peers
    [IPFS Network] as ipfsNet
}

main --> shardMgr : manages
main --> fileOps : orchestrates
main --> storage : uses
main --> metrics : collects
main --> rateLimit : uses
main --> discovery : initializes
main --> signingTrust : initializes

shardMgr --> clusterMgr : manages clusters
shardMgr --> pubsub : subscribes/publishes
shardMgr --> host : uses
shardMgr --> signingTrust : verifies messages
shardMgr --> storage : uses (resharding)

clusterMgr --> crdt : manages
clusterMgr --> pinTracker : starts
clusterMgr --> clusterStore : persists state

crdt --> pubsub : syncs state
crdt --> dht : routing
pinTracker --> crdt : reads state
pinTracker --> ipfsClient : pins content

fileOps --> storage : pins/unpins (via mgr)
fileOps --> shardMgr : checks responsibility
fileOps --> watcher : triggered by
fileOps --> ipfsClient : imports/pins
fileOps --> signingTrust : signs manifests/messages

storage --> dht : provides files
storage --> ipfsClient : pin/unpin DAGs

metrics --> storage : reads state
metrics --> shardMgr : reads shard info

rateLimit --> pubsub : filters messages
rateLimit --> storageMonitor : checks disk usage for Custodial

storageMonitor --> dataDir : monitors disk usage

discovery --> mdns : uses
discovery --> host : connects peers

host --> dht : provides routing
host --> pubsub : provides messaging
host --> peers : connects

dht --> ipfsNet : queries providers
pubsub --> peers : broadcasts messages
mdns --> peers : discovers locally

watcher --> dataDir : monitors

@enduml
