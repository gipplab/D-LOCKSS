@startuml D-LOCKSS Component Diagram

package "Core Components" {
    component "ShardManager" as ShardManager
    component "ClusterManager" as ClusterManager
    component "StorageManager" as StorageManager
    component "FileProcessor" as FileProcessor
    component Metrics
    component "Rate Limiter" as RateLimiter
}

ShardManager --> ClusterManager : joins/leaves shards
ClusterManager --> StorageManager : onPinSynced/onPinRemoved
FileProcessor --> StorageManager : pins files, adds known
FileProcessor --> ShardManager : PinToCluster, AnnouncePinned, responsibility
ShardManager --> RateLimiter : Check(peer) before processing messages
Metrics --> StorageManager : reads stats
Metrics --> ClusterManager : GetClusterMetrics (pins/peers per shard)

note right of ShardManager
    Manages shard assignment
    and PubSub topics.
    Splits when overcrowded (â‰¥12 peers).
    Discovery: join existing deeper shards.
    Rebroadcast SPLIT to ancestors for late joiners.
    Stability (v0.0.3):
    - Move cooldown (30s) after any transition
    - Jittered discovery timers
    - PROBE response rate limiting (5s)
    - Immediate LEAVE on departure
end note

note right of ClusterManager
    Manages embedded IPFS Clusters
    (CRDT Consensus).
    Syncs state between peers
    and drives local pinning.
end note

note right of StorageManager
    Owns local state:
    - PinnedFiles
    - KnownFiles
end note

note right of FileProcessor
    File ingestion
    and Manifest creation
end note

@enduml
