@startuml File Ingestion Sequence

actor User
participant "File System" as FS
participant "File Watcher" as Watcher
participant "File Ops" as FileOps
participant "Storage" as Storage
participant "IPFS" as IPFS
participant "ShardManager" as ShardMgr
participant "DHT" as DHT
participant "PubSub" as PubSub
participant "Other Nodes" as Nodes

User -> FS: Drop file into ./data
FS -> Watcher: File created event
Watcher -> FileOps: processNewFile(path)

FileOps -> IPFS: Import file (UnixFS)\nPayloadCID
FileOps -> FileOps: Build ResearchObject (CBOR)\n{title, authors, payload, refs, size}
FileOps -> IPFS: Put dag-cbor manifest block\nManifestCID
FileOps -> FileOps: Check BadBits (ManifestCID)\n(blocked for node country?)
alt BadBits check fails
    FileOps -> IPFS: UnpinRecursive(PayloadCID)\n(reject file)
    FileOps -> FileOps: Log refusal and return
else BadBits check passes
    FileOps -> IPFS: PinRecursive(ManifestCID)\n(recursive pin)
    Storage -> Storage: Track pinnedFiles[ManifestCID]
end

FileOps -> Storage: addKnownFile(ManifestCID)

FileOps -> ShardMgr: AmIResponsibleFor(PayloadCID)

alt Node is responsible
    FileOps -> DHT: provideFile(ManifestCID)\n(only responsible nodes announce)
    FileOps -> PubSub: PublishToShard(IngestMessage CBOR)\n{manifest_cid, hint_size} (shard topic)
    PubSub -> Nodes: Broadcast IngestMessage\n(only to same shard)
    Nodes -> Nodes: Add ManifestCID to knownFiles, check replication
else Node is NOT responsible (Custodial Mode)
    Note over FileOps: Do NOT announce to DHT\n(keep cross-shard communication minimal)
    FileOps -> ShardMgr: target_shard = prefix(hash(PayloadCID))
    FileOps -> PubSub: PublishToControl(DelegateMessage CBOR)\n{manifest_cid, target_shard} (control topic)
    PubSub -> Nodes: Broadcast DelegateMessage
    Nodes -> Nodes: Responsible node accepts delegation
    Nodes -> Nodes: checkReplication(ManifestCID)
end

@enduml
