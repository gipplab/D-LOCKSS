@startuml File Ingestion Sequence

actor User
participant "File System" as FS
participant "File Watcher" as Watcher
participant "FileProcessor" as FileOps
participant "StorageManager" as Storage
participant "ShardManager" as ShardMgr
participant "ClusterManager" as ClusterMgr
participant "CRDT" as CRDT
participant "IPFS" as IPFS
participant "DHT" as DHT
participant "PubSub" as PubSub
participant "Other Nodes" as Nodes

User -> FS: Drop file into ./data
FS -> Watcher: File created event
Watcher -> FileOps: processNewFile(path)

FileOps -> IPFS: Import file (UnixFS)\nPayloadCID
FileOps -> FileOps: Build ResearchObject (CBOR)\n{meta_ref, ingester_id, payload, size}
FileOps -> IPFS: PutDagCBOR(manifest)\nManifestCID
FileOps -> FileOps: Check BadBits (ManifestCID)
alt BadBits check fails
    FileOps -> IPFS: UnpinRecursive(ManifestCID)
    FileOps -> FileOps: Log refusal and return
else BadBits check passes
    FileOps -> IPFS: PinRecursive(ManifestCID)
end

FileOps -> FileOps: trackAndAnnounceFile(manifestCID, payloadCID)
FileOps -> Storage: PinFile(ManifestCID)
FileOps -> ShardMgr: AnnouncePinned(ManifestCID)\n(PINNED:<cid> on current shard topic)
FileOps -> ShardMgr: AmIResponsibleFor(PayloadCID)

alt Node is responsible
    FileOps -> ShardMgr: PinToCluster(ManifestCID)
    ShardMgr -> ClusterMgr: Pin(ctx, currentShard, cid, -1, -1)
    ClusterMgr -> CRDT: LogPin(pin)
    FileOps -> Storage: AddKnownFile(ManifestCID)
    FileOps -> FileOps: announceResponsibleFile()
    FileOps -> ShardMgr: PublishToShardCBOR(IngestMessage)\n(current shard topic)
    ShardMgr -> PubSub: Publish IngestMessage
    FileOps -> Storage: ProvideFile(ManifestCID)
    Storage -> DHT: Provide(ManifestCID)
else Node is NOT responsible (Custodial)
    FileOps -> Storage: AddKnownFile(ManifestCID)
    FileOps -> FileOps: announceCustodialFile()
    FileOps -> ShardMgr: JoinShard(targetShard)\nTargetShard = TargetShardForPayload(PayloadCID, depth)
    FileOps -> ShardMgr: EnsureClusterForShard(ctx, targetShard)
    ShardMgr -> ClusterMgr: JoinShard(ctx, targetShard)
    FileOps -> ShardMgr: PinToShard(ctx, targetShard, ManifestCID)
    ShardMgr -> ClusterMgr: Pin(ctx, targetShard, cid, -1, -1)
    ClusterMgr -> CRDT: LogPin (target shard's CRDT)
    FileOps -> ShardMgr: PublishToShardCBOR(IngestMessage, targetShard)
    ShardMgr -> PubSub: Publish IngestMessage to target shard topic
    PubSub -> Nodes: Forward (nodes in target shard)
    Note over FileOps: No DHT Provide; file lives only in target cluster
end

@enduml
