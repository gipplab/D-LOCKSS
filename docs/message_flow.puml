@startuml Message Flow Diagram

participant "Node A" as A
participant "GossipSub" as GS
participant "Node B" as B
participant "Node C" as C
participant "DHT" as DHT

== File Ingestion ==
A -> GS: IngestMessage(CBOR)\n{manifest_cid, shard_id, hint_size, ts, nonce, sig} (shard topic)
GS -> B: Forward message
GS -> C: Forward message
B -> B: Add to knownFiles
C -> C: Add to knownFiles

== Replication Request ==
A -> GS: ReplicationRequest(CBOR)\n{manifest_cid, priority, deadline, ts, nonce, sig} (shard topic)
GS -> B: Forward message (same shard only)
GS -> C: Forward message (same shard only)
B -> B: Check if responsible\n(AmIResponsibleFor(PayloadCID))
C -> C: Check if responsible\n(AmIResponsibleFor(PayloadCID))
alt B is responsible
    B -> DHT: Check if I have file
    alt File not pinned
        B -> IPFS: Fetch and pin file
        B -> DHT: provideFile(manifest_cid)\n(only responsible nodes announce)
    end
else B not responsible
    B -> B: Ignore (not in responsible shard)
end
alt C is responsible
    C -> DHT: Check if I have file
    alt File not pinned
        C -> IPFS: Fetch and pin file
        C -> DHT: provideFile(manifest_cid)\n(only responsible nodes announce)
    end
else C not responsible
    C -> C: Ignore (not in responsible shard)
end

== Delegation ==
A -> GS: DelegateMessage(CBOR)\n{manifest_cid, target_shard, ts, nonce, sig} (control topic)
GS -> B: Forward message
GS -> C: Forward message
B -> B: Check if prefix matches
C -> C: Check if prefix matches
alt Prefix matches (Node C)
    C -> C: Accept delegation
    C -> DHT: provideFile(manifest_cid)
else Prefix doesn't match
    B -> B: Ignore message
end

== Rate Limiting ==
A -> GS: Message
GS -> B: Forward
B -> B: checkRateLimit(A)
alt Rate limit OK
    B -> B: Process message
else Rate limit exceeded
    B -> B: Drop message
    B -> B: Increment messagesDropped
end

@enduml
