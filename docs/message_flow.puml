@startuml Message Flow Diagram

participant "Node A" as A
participant "GossipSub" as GS
participant "Node B" as B
participant "Node C" as C
participant "DHT" as DHT

== File Ingestion ==
A -> GS: IngestMessage(CBOR)\n{manifest_cid, shard_id, hint_size, ts, nonce, sig} (shard topic)
GS -> B: Forward message
GS -> C: Forward message
B -> B: Add to knownFiles
C -> C: Add to knownFiles

== Replication Request ==
A -> GS: ReplicationRequest(CBOR)\n{manifest_cid, priority, deadline, ts, nonce, sig} (shard topic)
GS -> B: Forward message (same shard only)
GS -> C: Forward message (same shard only)
B -> B: Check if responsible\n(AmIResponsibleFor(PayloadCID))
C -> C: Check if responsible\n(AmIResponsibleFor(PayloadCID))
alt B is responsible
    B -> DHT: Check if I have file
    alt File not pinned
        B -> IPFS: Fetch and pin file
        B -> DHT: provideFile(manifest_cid)\n(only responsible nodes announce)
    end
else B not responsible
    B -> B: Ignore (not in responsible shard)
end
alt C is responsible
    C -> DHT: Check if I have file
    alt File not pinned
        C -> IPFS: Fetch and pin file
        C -> DHT: provideFile(manifest_cid)\n(only responsible nodes announce)
    end
else C not responsible
    C -> C: Ignore (not in responsible shard)
end

== Tourist Pattern (Handoff) ==
note over A: Node A holds file but is not responsible.\nCalculates Target Shard (e.g. "10").
A -> GS: JoinShard("10")
A -> GS: IngestMessage(CBOR)\n{manifest_cid, shard_id="10", ...} (Topic: ...-shard-10)
GS -> C: Forward message (Node C is in Shard 10)
C -> C: Accept ingest
C -> DHT: provideFile(manifest_cid)
note over A: A monitors DHT for replicas.\nWhen replication >= Target, A unpins.
A -> GS: LeaveShard("10")

== Rate Limiting ==
A -> GS: Message
GS -> B: Forward
B -> B: checkRateLimit(A)
alt Rate limit OK
    B -> B: Process message
else Rate limit exceeded
    B -> B: Drop message
    B -> B: Increment messagesDropped
end

@enduml
