@startuml Custodial Handoff Sequence (Tourist Pattern)

participant "Custodial Node" as Custodial
participant "ShardManager" as ShardMgr
participant "ClusterManager" as ClusterMgr
participant "CRDT (target shard)" as CRDT
participant "Responsible Node" as Responsible
participant "StorageManager" as Storage
participant "IPFS" as IPFS
participant "PubSub" as PubSub

== Local ingest: we are NOT responsible ==

Custodial -> Custodial: trackAndAnnounceFile()\nAmIResponsibleFor(PayloadCID) == false
Custodial -> IPFS: PinRecursive(ManifestCID)  ' already done in checkBadBitsAndPin
Custodial -> Storage: PinFile(ManifestCID)
Custodial -> ShardMgr: AnnouncePinned(ManifestCID)

Custodial -> Custodial: announceCustodialFile()\ntargetShard = TargetShardForPayload(PayloadCID, depth)
Custodial -> ShardMgr: JoinShard(targetShard)
ShardMgr -> PubSub: Subscribe to dlockss-creative-commons-shard-<targetShard>
Custodial -> ShardMgr: EnsureClusterForShard(ctx, targetShard)
ShardMgr -> ClusterMgr: JoinShard(ctx, targetShard)
Custodial -> ShardMgr: PinToShard(ctx, targetShard, ManifestCID)
ShardMgr -> ClusterMgr: Pin(ctx, targetShard, cid, -1, -1)
ClusterMgr -> CRDT: LogPin(pin)
CRDT -> Responsible: Sync State (PubSub dlockss-shard-<targetShard>)

Responsible -> CRDT: LocalPinTracker sees new pin (we are in Allocations)
Responsible -> IPFS: PinRecursive(ManifestCID)
Responsible -> Storage: onPinSynced(cid)
Note over Responsible: Responsible node holds file in target cluster

Note over Custodial: Custodial remains in target shard as tourist.\nNo automatic unpin when replication sufficient;\nreshard/split may leave target shard later.

@enduml
