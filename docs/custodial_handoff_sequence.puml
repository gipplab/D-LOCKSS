@startuml Custodial Handoff Sequence (Tourist Pattern)

participant "Custodial Node" as Custodial
participant "Shard Manager" as ShardMgr
participant "Cluster Manager" as ClusterMgr
participant "CRDT" as CRDT
participant "Responsible Node" as Responsible
participant "StorageManager" as Storage
participant "IPFS" as IPFS

Custodial -> Custodial: processNewFile()\nPayloadCID not in my shard
Custodial -> IPFS: PinRecursive(ManifestCID)\n[temporary custodial hold]
Custodial -> Storage: pinFile(ManifestCID)

Custodial -> ShardMgr: JoinShard(TargetShard)
Custodial -> ClusterMgr: JoinShard(TargetShard)
Note over Custodial: Dual-Homing / Tourist

Custodial -> ClusterMgr: Pin(ManifestCID)
ClusterMgr -> CRDT: LogPin(ManifestCID)
CRDT -> Responsible: Sync State (PubSub)

Responsible -> CRDT: State Updated
Responsible -> IPFS: PinRecursive(ManifestCID)
Note over Responsible: Responsible node picks up file

Custodial -> CRDT: Check State (Replication Count)
alt Replication Sufficient
    Custodial -> IPFS: UnpinRecursive(ManifestCID)
    Custodial -> ClusterMgr: LeaveShard(TargetShard)
    Custodial -> ShardMgr: LeaveShard(TargetShard)
end

@enduml
