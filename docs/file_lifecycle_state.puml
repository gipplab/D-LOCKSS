@startuml File Lifecycle State Diagram

[*] --> Discovered: File detected in ./data

Discovered --> Pinned: PinRecursive(ManifestCID)\nPinFile(ManifestCID)

Pinned --> Responsible: AmIResponsibleFor(PayloadCID) == true\nPinToCluster(currentShard)\nPublish IngestMessage
Pinned --> Custodial: AmIResponsibleFor(PayloadCID) == false\nJoinShard(targetShard)\nPinToShard(targetShard)\nPublish IngestMessage to target shard

Custodial --> InTargetCluster: CRDT syncs; responsible nodes\nLocalPinTracker pin locally

Responsible --> InCluster: Pin in CRDT; LocalPinTracker\nsyncs to self and peers (allocations)

InCluster --> UnderReplicated: runReplicationChecker:\nallocations < MinReplication
UnderReplicated --> InCluster: ReplicationRequest -> peers\nPin(targetShard), TriggerSync

InCluster --> Removed: RunReshardPass: we split/moved\nfile belongs to other shard
Removed --> [*]: Unpin from cluster\nUnpinRecursive, UnpinFile

InTargetCluster --> [*]: Custodial may leave target shard later\n(no automatic unpin on replication count)

note right of Custodial
    Tourist: we inject file into
    target shard's cluster only.
    No DHT Provide.
end note

note right of InCluster
    File lives in exactly one cluster
    (shard by PayloadCID).
    LocalPinTracker allocation-aware.
end note

@enduml
