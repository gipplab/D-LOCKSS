@startuml Delegation Sequence

participant "Custodial Node" as Custodial
participant "PubSub Control" as Control
participant "Responsible Node" as Responsible
participant "Storage" as Storage
participant "Replication Checker" as ReplChecker
participant "DHT" as DHT

Custodial -> Custodial: processNewFile()\nFile hash doesn't match shard
Custodial -> Custodial: pinFile(hash) [temporary]
Custodial -> DHT: provideFile(hash)
Custodial -> Control: PublishToControl("DELEGATE:" + hash + ":" + prefix)

Control -> Responsible: Broadcast DELEGATE message
Responsible -> Responsible: checkRateLimitForMessage(peerID, "DELEGATE")
Responsible -> Responsible: Check disk usage

alt Rate limit OK AND disk usage OK
    Responsible -> Responsible: Check if targetPrefix == myShard
    
    alt Prefix matches
    Responsible -> Storage: addKnownFile(hash)
    Responsible -> ReplChecker: checkReplication(hash)
    ReplChecker -> DHT: FindProvidersAsync(cid)
    DHT -> ReplChecker: Provider count
    
    alt count < MinReplication
        ReplChecker -> Storage: pinFile(hash)
        ReplChecker -> DHT: provideFile(hash)
    end
    
    Note over Responsible: File now properly replicated
    
    alt Replication reaches MinReplication
        Custodial -> Custodial: checkReplication(hash)
        Custodial -> DHT: FindProvidersAsync(cid)
        DHT -> Custodial: count >= MinReplication
        Custodial -> Storage: unpinFile(hash)
        Note over Custodial: Custodial handoff complete
    end
    else Prefix doesn't match
        Responsible -> Responsible: Ignore message
    end
else Rate limit exceeded OR disk usage high
    Responsible -> Responsible: Reject DELEGATE message
    Note over Responsible: Disk usage protection\nprevents accepting custodial files
end

@enduml
